
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../gameplay/">
      
      
        <link rel="next" href="../overview/">
      
      <link rel="icon" href="../assets/logo.png">
      <meta name="generator" content="mkdocs-1.5.1, mkdocs-material-9.1.21">
    
    
      
        <title>Implementation - OpenCube Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.eebd395e.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="light-green">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#implementation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="OpenCube Documentation" class="md-header__button md-logo" aria-label="OpenCube Documentation" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OpenCube Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Implementation
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="OpenCube Documentation" class="md-nav__button md-logo" aria-label="OpenCube Documentation" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    OpenCube Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../download/" class="md-nav__link">
        Download
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../gameplay/" class="md-nav__link">
        Gameplay
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Implementation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Implementation
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    Implementation
  </a>
  
    <nav class="md-nav" aria-label="Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multiplayer" class="md-nav__link">
    Multiplayer
  </a>
  
    <nav class="md-nav" aria-label="Multiplayer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#server" class="md-nav__link">
    Server
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terrain-generation" class="md-nav__link">
    Terrain Generation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rendering" class="md-nav__link">
    Rendering
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database" class="md-nav__link">
    Database
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collision-testing" class="md-nav__link">
    Collision Testing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sky-dome" class="md-nav__link">
    Sky Dome
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    Dependencies
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../python_api/" class="md-nav__link">
        Python api
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    Implementation
  </a>
  
    <nav class="md-nav" aria-label="Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multiplayer" class="md-nav__link">
    Multiplayer
  </a>
  
    <nav class="md-nav" aria-label="Multiplayer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#server" class="md-nav__link">
    Server
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terrain-generation" class="md-nav__link">
    Terrain Generation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rendering" class="md-nav__link">
    Rendering
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database" class="md-nav__link">
    Database
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collision-testing" class="md-nav__link">
    Collision Testing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sky-dome" class="md-nav__link">
    Sky Dome
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    Dependencies
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Implementation</h1>

<h2 id="implementation">Implementation</h2>
<p>Lists implementation details from the README.md</p>
<h3 id="multiplayer">Multiplayer</h3>
<p>Multiplayer mode is implemented using plain-old sockets. A simple, ASCII, line-based protocol is used.
Each line is made up of a command code and zero or more comma-separated arguments. The client requests chunks from the server with a simple command: C,p,q,key.
“C” means “Chunk” and (p, q) identifies the chunk. The key is used for caching - the server will only send block updates that have been performed since the client last asked for that chunk.
Block updates (in realtime or as part of a chunk request) are sent to the client in the format: B,p,q,x,y,z,w. After sending all of the blocks for a requested chunk, the server will send an updated cache key in the format: K,p,q,key.
The client will store this key and use it the next time it needs to ask for that chunk. Player positions are sent in the format: P,pid,x,y,z,rx,ry. The pid is the player ID and the rx and ry values indicate the player’s rotation in two different axes.
The client interpolates player positions from the past two position updates for smoother animation. The client sends its position to the server at most every 0.1 seconds (less if not moving).</p>
<p>Client-side caching to the sqlite database can be performance intensive when connecting to a server for the first time.
For this reason, sqlite writes are performed on a background thread. All writes occur in a transaction for performance.
The transaction is committed every 5 seconds as opposed to some logical amount of work completed.
A ring / circular buffer is used as a queue for what data is to be written to the database.</p>
<p>In multiplayer mode, players can observe one another in the main view or in a picture-in-picture view.
Implementation of the PnP was surprisingly simple - just change the viewport and render the scene again from the other player’s point of view.</p>
<hr />
<h4 id="server">Server</h4>
<p>You can connect to a server with command line arguments...</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>bash
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>./craft<span class="w"> </span><span class="o">[</span>HOST<span class="w"> </span><span class="o">[</span>PORT<span class="o">]]</span>
</span></code></pre></div>
<p>Or, with the "/online" command in the game itself.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>/online [HOST [PORT]]
</span></code></pre></div>
<p>You can run your own server or connect to an existing one. The server is written in Python
but requires a compiled DLL so it can perform the terrain generation just like
the client.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>bash
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>gcc<span class="w"> </span>-std<span class="o">=</span>c99<span class="w"> </span>-O3<span class="w"> </span>-fPIC<span class="w"> </span>-shared<span class="w"> </span>-o<span class="w"> </span>world<span class="w"> </span>-I<span class="w"> </span>src<span class="w"> </span>-I<span class="w"> </span>deps/noise<span class="w"> </span>deps/noise/noise.c<span class="w"> </span>src/world.c
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>python<span class="w"> </span>server.py<span class="w"> </span><span class="o">[</span>HOST<span class="w"> </span><span class="o">[</span>PORT<span class="o">]]</span>
</span></code></pre></div>
<hr />
<h3 id="terrain-generation">Terrain Generation</h3>
<p>The terrain is generated using Simplex noise - a deterministic noise function seeded based on position.
So the world will always be generated the same way in a given location.</p>
<p>The world is split up into 32x32 block chunks in the XZ plane (Y is up).
This allows the world to be “infinite” (floating point precision is currently a problem at large X or Z values) and also makes it easier to manage the data.
Only visible chunks need to be queried from the database.</p>
<hr />
<h3 id="rendering">Rendering</h3>
<p>Only exposed faces are rendered. This is an important optimization as the vast majority of blocks are either completely hidden or are only exposing one or two faces.
Each chunk records a one-block width overlap for each neighboring chunk so it knows which blocks along its perimeter are exposed.</p>
<p>Only visible chunks are rendered. A naive frustum-culling approach is used to test if a chunk is in the camera’s view.
If it is not, it is not rendered. This results in a pretty decent performance improvement as well.</p>
<p>Chunk buffers are completely regenerated when a block is changed in that chunk, instead of trying to update the VBO.</p>
<p>Text is rendered using a bitmap atlas. Each character is rendered onto two triangles forming a 2D rectangle.</p>
<p>“Modern” OpenGL is used - no deprecated, fixed-function pipeline functions are used.
Vertex buffer objects are used for position, normal and texture coordinates. Vertex and fragment shaders are used for rendering.
Matrix manipulation functions are in matrix.c for translation, rotation, perspective, orthographic, etc. matrices.
The 3D models are made up of very simple primitives - mostly cubes and rectangles. These models are generated in code in cube.c.</p>
<p>Transparency in glass blocks and plants (plants don’t take up the full rectangular shape of their triangle primitives) is implemented by discarding magenta-colored pixels in the fragment shader.</p>
<hr />
<h3 id="database">Database</h3>
<p>User changes to the world are stored in a sqlite database. Only the delta is stored,
so the default world is generated and then the user changes are applied on top when loading.</p>
<p>The main database table is named “block” and has columns p, q, x, y, z, w. (p, q) identifies the chunk,
(x, y, z) identifies the block position and (w) identifies the block type. 0 represents an empty block (air).</p>
<p>In game, the chunks store their blocks in a hash map. An (x, y, z) key maps to a (w) value.</p>
<p>The y-position of blocks are limited to 0 &lt;= y &lt; 256. The upper limit is mainly an artificial limitation to prevent users from building unnecessarily tall structures.
Users are not allowed to destroy blocks at y = 0 to avoid falling underneath the world.</p>
<hr />
<h3 id="collision-testing">Collision Testing</h3>
<p>Hit testing (what block the user is pointing at) is implemented by scanning a ray from the player’s position outward, following their sight vector.
This is not a precise method, so the step rate can be made smaller to be more accurate.</p>
<p>Collision testing simply adjusts the player’s position to remain a certain distance away from any adjacent blocks that are obstacles.
(Clouds and plants are not marked as obstacles, so you pass right through them.)</p>
<hr />
<h3 id="sky-dome">Sky Dome</h3>
<p>A textured sky dome is used for the sky. The X-coordinate of the texture represents time of day.
The Y-values map from the bottom of the sky sphere to the top of the sky sphere. The player is always in the center of the sphere.
The fragment shaders for the blocks also sample the sky texture to determine the appropriate fog color to blend with based on the block’s position relative to the backing sky.</p>
<hr />
<h3 id="dependencies">Dependencies</h3>
<ul>
<li>GLEW is used for managing OpenGL extensions across platforms.</li>
<li>GLFW is used for cross-platform window management.</li>
<li>CURL is used for HTTPS / SSL POST for the authentication process.</li>
<li>lodepng is used for loading PNG textures.</li>
<li>sqlite3 is used for saving the blocks added / removed by the user.</li>
<li>tinycthread is used for cross-platform threading.</li>
</ul>
<hr />





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "content.code.select"], "search": "../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.220ee61c.min.js"></script>
      
    
  </body>
</html>